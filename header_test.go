/*
 * Copyright (c) 2019 Alec Randazzo
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 */

package GoFor_MFT_Parser

import (
	"encoding/hex"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestMasterFileTableRecord_getRecordHeader(t *testing.T) {
	mftBytes, _ := hex.DecodeString("46494C45300003009B1565BC210000000100010038000100C801000000040000000000000000000007000000000000001D07000000000000100000006000000000001800000000004800000018000000EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D10106000000000000000000000000000000000000000001000000000000000000000000000000000000300000006800000000001800000003004A000000180001000500000000000500EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101004000000000000000400000000000000600000000000000040324004D00460054000000000000008000000078000000010040000000060000000000000000003F3705000000000040000000000000000000745300000000000074530000000000007453000000003320C80000000C436D9401D485E2014336D2006AFA7B0942FD0CF13008F5424563C94EE4084361D100EB51C60143DAC60011E49601000000B000000048000000010040000000050000000000000000002A00000000000000400000000000000000B002000000000008A002000000000008A0020000000000312B67F402000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF0000000008100000000000003101FFFF0B1101FF0000000000001D07FFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001D07")

	tests := []struct {
		name                string
		mftRecord           *MasterFileTableRecord
		wantRecordNumber    uint32
		wantAttributeOffset uint16
	}{
		{
			name: "Testing with MFT record 0.",
			mftRecord: &MasterFileTableRecord{
				MftRecordBytes: mftBytes,
			},
			wantRecordNumber:    0,
			wantAttributeOffset: 0x38,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			tt.mftRecord.GetRecordHeader()
			assert.Equal(t, tt.wantRecordNumber, tt.mftRecord.RecordHeader.RecordNumber, "The two record numbers should be equal.")
			assert.Equal(t, tt.wantAttributeOffset, tt.mftRecord.RecordHeader.AttributesOffset, "The two attribute offsets should be equal.")

		})
	}
}

func TestMasterFileTableRecord_getHeaderFlags(t *testing.T) {
	mftBytes, _ := hex.DecodeString("46494C45300003009B1565BC210000000100010038000100C801000000040000000000000000000007000000000000001D07000000000000100000006000000000001800000000004800000018000000EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D10106000000000000000000000000000000000000000001000000000000000000000000000000000000300000006800000000001800000003004A000000180001000500000000000500EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101EA24CD4A74D4D101004000000000000000400000000000000600000000000000040324004D00460054000000000000008000000078000000010040000000060000000000000000003F3705000000000040000000000000000000745300000000000074530000000000007453000000003320C80000000C436D9401D485E2014336D2006AFA7B0942FD0CF13008F5424563C94EE4084361D100EB51C60143DAC60011E49601000000B000000048000000010040000000050000000000000000002A00000000000000400000000000000000B002000000000008A002000000000008A0020000000000312B67F402000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF0000000008100000000000003101FFFF0B1101FF0000000000001D07FFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001D07")

	tests := []struct {
		name              string
		mftRecord         *MasterFileTableRecord
		wantFlagDeleted   bool
		wantFlagDirectory bool
	}{
		{
			name: "Testing with MFT record 0.",
			mftRecord: &MasterFileTableRecord{
				MftRecordBytes: mftBytes,
			},
			wantFlagDeleted:   false,
			wantFlagDirectory: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			tt.mftRecord.getHeaderFlags()
			assert.Equal(t, tt.wantFlagDirectory, tt.mftRecord.RecordHeader.FlagDirectory, "The Directory flags should be equal.")
			assert.Equal(t, tt.wantFlagDeleted, tt.mftRecord.RecordHeader.FlagDeleted, "The deleted flags should be equal.")
		})
	}
}
